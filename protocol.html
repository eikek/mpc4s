<html><head><title>mpc4s: Protocol</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="eikek" /><meta name="description" content="Scala- and Web-Client for MPD" /><meta name="og:image" content="/mpc4s/img/poster.png" /><meta name="og:title" content="mpc4s: Protocol" /><meta name="og:site_name" content="mpc4s" /><meta name="og:url" content="https://github.com/eikek/mpc4s" /><meta name="og:type" content="website" /><meta name="og:description" content="Scala- and Web-Client for MPD" /><link rel="icon" type="image/png" href="/mpc4s/img/favicon.png" /><meta name="twitter:title" content="mpc4s: Protocol" /><meta name="twitter:image" content="https://github.com/eikek/mpc4simg/poster.png" /><meta name="twitter:description" content="Scala- and Web-Client for MPD" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="96x96" href="/mpc4s/img/favicon.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/mpc4s/highlight/styles/default.css" /><link rel="stylesheet" href="/mpc4s/css/style.css" /><link rel="stylesheet" href="/mpc4s/css/palette.css" /><link rel="stylesheet" href="/mpc4s/css/codemirror.css" /><link rel="stylesheet" href="/mpc4s/css/mpc4s.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/mpc4s/" class="brand"><div class="brand-wrapper"><span>mpc4s</span></div></a></li> <li><a href="/mpc4s/index.html" class="">Home</a></li> <li><a href="/mpc4s/protocol.html" class=" active ">Protocol</a></li> <li><a href="/mpc4s/client.html" class="">Client</a></li> <li><a href="/mpc4s/http.html" class="">Http</a> <ul class="sub_section"> <li><a href="/mpc4s/http/configuration.html" class="">Configuration</a></li> <li><a href="/mpc4s/http/install.html" class="">Install</a></li> <li><a href="/mpc4s/http/endpoints.html" class="">Endpoints</a></li></ul></li> <li><a href="/mpc4s/player.html" class="">Player</a></li></ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/eikek/mpc4s"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/eikek/mpc4s"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="eikek" data-github-repo="mpc4s"><div class="content-wrapper"><section><h1 id="protocol">Protocol</h1>

<p>This module implements <a href="https://www.musicpd.org/doc/protocol/">MPD’s
protocol</a> in terms of case
classes and conversions from/to MPD commands and responses.</p>

<p>It’s only dependency is
<a href="https://github.com/milessabin/shapeless/">shapeless</a>.</p>

<p>Almost all commands and its corresponding answers are
implemented. Deprecated commands and some that I couldn’t get to work
are missing.</p>

<h2 id="structuring">Structuring</h2>

<p>Case classes for various data types are in package
<code class="highlighter-rouge">mpc4s.protocol</code>. Specific MPD command and response types in packages
<code class="highlighter-rouge">mpc4s.protocol.commands</code> and <code class="highlighter-rouge">mpc4s.protocol.answer</code>,
respectively. The package <code class="highlighter-rouge">mpc4s.protocol.codecs</code> contains the
conversion from/to MPD protocol.</p>

<h2 id="examples">Examples</h2>

<h3 id="commands">Commands</h3>

<p>For example, to parse a <code class="highlighter-rouge">find</code> command:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">mpc4s.protocol._</span><span class="o">,</span> <span class="n">mpc4s</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="k">_</span>
<span class="c1">// import mpc4s.protocol._
// import mpc4s.protocol.codec._
</span>
<span class="k">val</span> <span class="n">cc</span> <span class="k">=</span> <span class="nc">CommandCodec</span><span class="o">.</span><span class="n">defaultCodec</span>
<span class="c1">// cc: mpc4s.protocol.codec.LineCodec[mpc4s.protocol.Command] = mpc4s.protocol.codec.LineCodec$$anon$3@5ee6b241
</span>
<span class="k">val</span> <span class="n">cmd</span> <span class="k">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">parseValue</span><span class="o">(</span><span class="s">"find album Echoes"</span><span class="o">)</span>
<span class="c1">// cmd: mpc4s.protocol.codec.Result[mpc4s.protocol.Command] = Right(Find(Filter(ListMap(Map(TagFilter(Album) -&gt; Echoes))),None,None))
</span>
<span class="n">cc</span><span class="o">.</span><span class="n">write</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">get</span><span class="o">)</span>
<span class="c1">// res0: mpc4s.protocol.codec.Result[String] = Right(find album Echoes)
</span></code></pre></div></div>

<p>The <code class="highlighter-rouge">CommandCodec.defaultCodec</code> can parse most mpd commands. In the
example above the command was parsed into an object of class
<code class="highlighter-rouge">Find</code>. Every command has its codec defined in its companion
object. And all of them are then pulled together in <code class="highlighter-rouge">CommandCodec</code>.</p>

<h3 id="responses">Responses</h3>

<p>This example parses the response to the <code class="highlighter-rouge">status</code> command:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">mpc4s.protocol.answer._</span>
<span class="c1">// import mpc4s.protocol.answer._
</span>
<span class="k">val</span> <span class="n">mpdResponse</span> <span class="k">=</span> <span class="s">"""volume: 90
repeat: 0
random: 0
single: 0
consume: 0
playlist: 2
playlistlength: 1
mixrampdb: 0.000000
state: play
song: 0
songid: 1
time: 36:780
elapsed: 36.223
bitrate: 457
duration: 780.000
audio: 44100:16:2
"""</span>
<span class="c1">// mpdResponse: String =
// "volume: 90
// repeat: 0
// random: 0
// single: 0
// consume: 0
// playlist: 2
// playlistlength: 1
// mixrampdb: 0.000000
// state: play
// song: 0
// songid: 1
// time: 36:780
// elapsed: 36.223
// bitrate: 457
// duration: 780.000
// audio: 44100:16:2
// "
</span>
<span class="k">val</span> <span class="n">codec</span> <span class="k">=</span> <span class="nc">StatusAnswer</span><span class="o">.</span><span class="n">codec</span>
<span class="c1">// codec: mpc4s.protocol.codec.LineCodec[mpc4s.protocol.answer.StatusAnswer] = mpc4s.protocol.codec.LineCodec$$anon$2@49cc8ac
</span>
<span class="k">val</span> <span class="n">answer</span> <span class="k">=</span> <span class="n">codec</span><span class="o">.</span><span class="n">parseValue</span><span class="o">(</span><span class="n">mpdResponse</span><span class="o">)</span>
<span class="c1">// answer: mpc4s.protocol.codec.Result[mpc4s.protocol.answer.StatusAnswer] = Right(StatusAnswer(90,false,false,Off,false,2,1,Play,Some(0),Some(Id(1)),None,None,Some(Range(36,780)),Some(36.223),Some(780.0),Some(457),None,Some(0.0),Some(AudioFormat(44100,16,2)),Some(),Some()))
</span>
<span class="n">codec</span><span class="o">.</span><span class="n">write</span><span class="o">(</span><span class="n">answer</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">get</span><span class="o">)</span>
<span class="c1">// res1: mpc4s.protocol.codec.Result[String] =
// Right(volume: 90
// repeat: 0
// random: 0
// single: 0
// consume: 0
// playlist: 2
// playlistlength: 1
// state: play
// song: 0
// songid: 1
// time: 36:780
// elapsed: 36.223
// duration: 780.0
// bitrate: 457
// mixrampdb: 0.0
// audio: 44100:16:2
// )
</span></code></pre></div></div>

<p><code class="highlighter-rouge">Answer</code> defines the payload returned from MPD, which are implemented
in <code class="highlighter-rouge">mpc4s.protocol.answer</code> package (that also contains
<code class="highlighter-rouge">StatusAnswer</code>). As with commands, the codec for an answer type is
defined in its companion object.</p>

<p>There is also an <code class="highlighter-rouge">Response</code> trait which represents the response from
MPD: either an error or some <code class="highlighter-rouge">Answer</code>. MPD responds with some payload
(which may be empty) terminated by <code class="highlighter-rouge">"OK\n"</code>, or with a so called <code class="highlighter-rouge">ACK</code>
response. A codec for a response can be looked up from implicit scope,
if a codec for <code class="highlighter-rouge">Answer</code> is available:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">mpc4s.protocol._</span><span class="o">,</span> <span class="n">mpc4s</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">answer</span><span class="o">.</span><span class="k">_</span>
<span class="c1">// import mpc4s.protocol._
// import mpc4s.protocol.answer._
</span>
<span class="k">val</span> <span class="n">codec</span> <span class="k">=</span> <span class="n">implicitly</span><span class="o">[</span><span class="kt">LineCodec</span><span class="o">[</span><span class="kt">Response</span><span class="o">[</span><span class="kt">StatusAnswer</span><span class="o">]]]</span>
<span class="c1">// codec: mpc4s.protocol.codec.LineCodec[mpc4s.protocol.Response[mpc4s.protocol.answer.StatusAnswer]] = mpc4s.protocol.codec.LineCodec$$anon$1@2add5166
</span>
<span class="k">val</span> <span class="n">mpdResponse</span> <span class="k">=</span> <span class="s">"""volume: 90
repeat: 0
random: 0
single: 0
consume: 0
playlist: 2
playlistlength: 1
mixrampdb: 0.000000
state: play
song: 0
songid: 1
time: 36:780
elapsed: 36.223
bitrate: 457
duration: 780.000
audio: 44100:16:2
OK
"""</span>
<span class="c1">// mpdResponse: String =
// "volume: 90
// repeat: 0
// random: 0
// single: 0
// consume: 0
// playlist: 2
// playlistlength: 1
// mixrampdb: 0.000000
// state: play
// song: 0
// songid: 1
// time: 36:780
// elapsed: 36.223
// bitrate: 457
// duration: 780.000
// audio: 44100:16:2
// OK
// "
</span>
<span class="n">codec</span><span class="o">.</span><span class="n">parseValue</span><span class="o">(</span><span class="n">mpdResponse</span><span class="o">)</span>
<span class="c1">// res2: mpc4s.protocol.codec.Result[mpc4s.protocol.Response[mpc4s.protocol.answer.StatusAnswer]] = Right(MpdResult(StatusAnswer(90,false,false,Off,false,2,1,Play,Some(0),Some(Id(1)),None,None,Some(Range(36,780)),Some(36.223),Some(780.0),Some(457),None,Some(0.0),Some(AudioFormat(44100,16,2)),Some(),Some())))
</span>
<span class="k">val</span> <span class="n">ack</span> <span class="k">=</span> <span class="s">"ACK [50@2] {play} file not found\n"</span>
<span class="c1">// ack: String =
// "ACK [50@2] {play} file not found
// "
</span>
<span class="n">codec</span><span class="o">.</span><span class="n">parseValue</span><span class="o">(</span><span class="n">ack</span><span class="o">)</span>
<span class="c1">// res3: mpc4s.protocol.codec.Result[mpc4s.protocol.Response[mpc4s.protocol.answer.StatusAnswer]] = Right(MpdError(Ack(FileNotFound,2,play,file not found)))
</span></code></pre></div></div>

<h3 id="selecting-the-correct-response-codec">Selecting the correct response codec</h3>

<p>The correct codec for a mpd response depends on the command. The
commands specify their answer type using an implicit value of
<code class="highlighter-rouge">SelectAnswer</code>. For example, the <code class="highlighter-rouge">list</code> command expects its response
to be a <code class="highlighter-rouge">ListAnswer</code>. So it there is this line it the companion object
of <code class="highlighter-rouge">List</code>:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">selectAnswer</span> <span class="k">=</span> <span class="nc">SelectAnswer</span><span class="o">[</span><span class="kt">List</span>, <span class="kt">ListAnswer</span><span class="o">]</span>
</code></pre></div></div>

<p>This can be used to let the compiler select the correct codec for a
response given the command:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">mpc4s.protocol._</span><span class="o">,</span> <span class="n">mpc4s</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="k">_</span>
<span class="c1">// import mpc4s.protocol._
// import mpc4s.protocol.commands._
</span>
<span class="k">def</span> <span class="n">chooseCodec</span><span class="o">[</span><span class="kt">C</span> <span class="k">&lt;:</span> <span class="kt">Command</span>, <span class="kt">A</span> <span class="k">&lt;:</span> <span class="kt">Answer</span><span class="o">](</span><span class="n">cmd</span><span class="k">:</span> <span class="kt">C</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">s</span><span class="k">:</span> <span class="kt">SelectAnswer</span><span class="o">[</span><span class="kt">C</span>, <span class="kt">A</span><span class="o">])</span> <span class="k">=</span>
  <span class="n">s</span><span class="o">.</span><span class="n">codec</span>
<span class="c1">// chooseCodec: [C &lt;: mpc4s.protocol.Command, A &lt;: mpc4s.protocol.Answer](cmd: C)(implicit s: mpc4s.protocol.SelectAnswer[C,A])mpc4s.protocol.codec.LineCodec[mpc4s.protocol.Response[A]]
</span>
<span class="n">chooseCodec</span><span class="o">(</span><span class="nc">Status</span><span class="o">)</span>
<span class="c1">// res4: mpc4s.protocol.codec.LineCodec[mpc4s.protocol.Response[mpc4s.protocol.answer.StatusAnswer]] = mpc4s.protocol.codec.LineCodec$$anon$1@49c51eef
</span></code></pre></div></div>

<p>All this is pulled together in a map in <code class="highlighter-rouge">CommandCodec</code> that can be
used to select codecs at runtime. It is called <code class="highlighter-rouge">ProtocolConfig</code> which
is a type alias:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="kt">ProtocolConfig</span> <span class="o">=</span> <span class="nc">Map</span><span class="o">[</span><span class="kt">CommandName</span>, <span class="kt">CommandName.Config</span><span class="o">]</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">CommandName.Config</code> has everything needed to parse/write a
command and its response. Using this map, a codec for all commands can
be created. <code class="highlighter-rouge">CommandCodec.defaultConfig</code> is the default
<code class="highlighter-rouge">ProtocolConfig</code> containing all commands from this module. And
<code class="highlighter-rouge">CommandCodec.defaultCodec</code> is the codec created using
<code class="highlighter-rouge">CommandCodec.defaultConfig</code>.</p>

<p>Using that, a response and command codec can be looked up at runtime:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">mpc4s.protocol.commands._</span><span class="o">,</span> <span class="n">mpc4s</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">codec</span><span class="o">.</span><span class="k">_</span>
<span class="c1">// import mpc4s.protocol.commands._
// import mpc4s.protocol.codec._
</span>
<span class="c1">// Using type Command, simulating we do not know the concrete type
</span><span class="k">val</span> <span class="n">cmd</span><span class="k">:</span> <span class="kt">Command</span> <span class="o">=</span> <span class="nc">Status</span>
<span class="c1">// cmd: mpc4s.protocol.Command = Status
</span>
<span class="c1">// Looking up a CommandName.Config object using the command name
</span><span class="k">val</span> <span class="n">cfg</span> <span class="k">=</span> <span class="nc">CommandCodec</span><span class="o">.</span><span class="n">defaultConfig</span><span class="o">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
<span class="c1">// cfg: mpc4s.protocol.CommandName.Config = mpc4s.protocol.CommandName$Config$$anon$2@61e5d66e
</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">commandCodec</span><span class="o">.</span><span class="n">parseValue</span><span class="o">(</span><span class="s">"status"</span><span class="o">)</span>
<span class="c1">// res7: mpc4s.protocol.codec.Result[cfg.Cmd] = Right(Status)
</span>
<span class="n">cfg</span><span class="o">.</span><span class="n">responseCodec</span><span class="o">.</span><span class="n">parseValue</span><span class="o">(</span><span class="s">"""volume: 90
repeat: 0
random: 0
single: 0
consume: 0
playlist: 2
playlistlength: 1
mixrampdb: 0.000000
state: play
song: 0
songid: 1
time: 36:780
elapsed: 36.223
bitrate: 457
duration: 780.000
audio: 44100:16:2
OK
"""</span><span class="o">)</span>
<span class="c1">// res8: mpc4s.protocol.codec.Result[mpc4s.protocol.Response[cfg.Ans]] = Right(MpdResult(StatusAnswer(90,false,false,Off,false,2,1,Play,Some(0),Some(Id(1)),None,None,Some(Range(36,780)),Some(36.223),Some(780.0),Some(457),None,Some(0.0),Some(AudioFormat(44100,16,2)),Some(),Some())))
</span></code></pre></div></div>

<p>As you can see all the concrete types are gone, since we only have
that information at runtime.</p>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/mpc4s/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script src="/mpc4s/js/main.js"></script></body></html>