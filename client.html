<!DOCTYPE html><html><head><title>mpc4s: Client</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="eikek" /><meta name="description" content="Scala- and Web-Client for MPD" /><meta name="og:image" content="/mpc4s/img/poster.png" /><meta name="image" property="og:image" content="/mpc4s/img/poster.png" /><meta name="og:title" content="mpc4s: Client" /><meta name="title" property="og:title" content="mpc4s: Client" /><meta name="og:site_name" content="mpc4s" /><meta name="og:url" content="https://github.com/eikek/mpc4s" /><meta name="og:type" content="website" /><meta name="og:description" content="Scala- and Web-Client for MPD" /><link rel="icon" type="image/png" href="/mpc4s/img/favicon.png" /><meta name="twitter:title" content="mpc4s: Client" /><meta name="twitter:image" content="/mpc4s/img/poster.png" /><meta name="twitter:description" content="Scala- and Web-Client for MPD" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="96x96" href="/mpc4s/img/favicon.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/mpc4s/highlight/styles/vs.css" /><link rel="stylesheet" href="/mpc4s/css/light-style.css" /><link rel="stylesheet" href="/mpc4s/css/mpc4s.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><div id="sidebar-brand"><a href="/mpc4s/" class="brand"><div class="brand-wrapper"></div><span>mpc4s</span></a><button id="main-toggle" class="sidebar-toggle"><span class="close"></span></button></div><div class="sidebar-nav"> <div class="sidebar-nav-item  "><a href="/mpc4s/index.html" title="Home" class="">Home</a></div> <div class="sidebar-nav-item  "><a href="/mpc4s/protocol.html" title="Protocol" class="">Protocol</a></div> <div class="sidebar-nav-item active "><a href="/mpc4s/client.html" title="Client" class="active">Client</a></div> <div class="sidebar-nav-item  "><a href="/mpc4s/http.html" title="Http" class="drop-nested">Http</a><i class="fa fa-angle-right"></i><div class="sub-section"> <a href="/mpc4s/http/configuration.html" title="Configuration" class="">Configuration</a> <a href="/mpc4s/http/install.html" title="Install" class="">Install</a> <a href="/mpc4s/http/endpoints.html" title="Endpoints" class="">Endpoints</a></div></div> <div class="sidebar-nav-item  "><a href="/mpc4s/player.html" title="Player" class="">Player</a></div></div></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li id="gh-eyes-item" class="hidden-xs"><a href="https://github.com/eikek/mpc4s" target="_blank" rel="noopener noreferrer"><i class="fa fa-eye"></i><span>Watchers<span id="eyes" class="label label-default">--</span></span></a></li><li id="gh-stars-item" class="hidden-xs"><a href="https://github.com/eikek/mpc4s" target="_blank" rel="noopener noreferrer"><i class="fa fa-star-o"></i><span>Stars<span id="stars" class="label label-default">--</span></span></a></li></ul></div></div></div></div><div id="content" data-github-owner="eikek" data-github-repo="mpc4s"><div class="content-wrapper"><section><h1 id="client">Client</h1>

<p>Building on the <a href="./protocol.html">protocol</a> module, this is a mpd
client library using
<a href="https://github.com/functional-streams-for-scala/fs2">FS2</a>.</p>

<p>The entry point is <code class="highlighter-rouge">MpdClient</code> which provides ways to send commands
and receive responses.</p>

<p>A <code class="highlighter-rouge">MpdClient</code> can be created like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">java.nio.channels.AsynchronousChannelGroup</span>
<span class="c1">// import java.nio.channels.AsynchronousChannelGroup</span>

<span class="k">import</span> <span class="nn">java.util.concurrent._</span>
<span class="c1">// import java.util.concurrent._</span>

<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>
<span class="c1">// import scala.concurrent.ExecutionContext</span>

<span class="k">import</span> <span class="nn">cats.effect.IO</span>
<span class="c1">// import cats.effect.IO</span>

<span class="k">import</span> <span class="nn">mpc4s.client._</span>
<span class="c1">// import mpc4s.client._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">EC</span> <span class="k">=</span> <span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">fromExecutorService</span><span class="o">(</span><span class="nv">Executors</span><span class="o">.</span><span class="py">newCachedThreadPool</span><span class="o">)</span>
<span class="c1">// EC: scala.concurrent.ExecutionContextExecutorService = scala.concurrent.impl.ExecutionContextImpl$$anon$4@7728bed</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">ACG</span> <span class="k">=</span> <span class="nv">AsynchronousChannelGroup</span><span class="o">.</span><span class="py">withThreadPool</span><span class="o">(</span><span class="nc">EC</span><span class="o">)</span>
<span class="c1">// ACG: java.nio.channels.AsynchronousChannelGroup = sun.nio.ch.EPollPort@c6ca1</span>

<span class="k">val</span> <span class="nv">mpc</span> <span class="k">=</span> <span class="nc">MpdClient</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="nc">Connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">6600</span><span class="o">))</span>
<span class="c1">// mpc: mpc4s.client.MpdClient[cats.effect.IO] = mpc4s.client.MpdClient$$anon$1@27d8008a</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">MpdClient</code> allows to <code class="highlighter-rouge">connect</code> to mpd returning a single element
<code class="highlighter-rouge">Stream</code> of a <code class="highlighter-rouge">MpdConnection</code>. The connection is closed, once the
<code class="highlighter-rouge">Stream</code> terminates, so the connection must be accessed “inside” that
Stream, for example using <code class="highlighter-rouge">flatMap</code>.</p>

<p>Additionally there are <code class="highlighter-rouge">send</code> methods defined for conveniently
issueing commands.</p>

<p>Here is an example to send a simple command:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="nv">resp</span> <span class="k">=</span> <span class="nv">mpc</span><span class="o">.</span><span class="py">send</span><span class="o">(</span><span class="nc">Search</span><span class="o">(</span><span class="nv">Filter</span><span class="o">.</span><span class="py">tags</span><span class="o">(</span><span class="nv">Tag</span><span class="o">.</span><span class="py">Album</span> <span class="o">-&gt;</span> <span class="s">"plays"</span><span class="o">),</span> <span class="nc">None</span><span class="o">,</span> <span class="nc">None</span><span class="o">),</span> <span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span>
<span class="n">resp</span><span class="k">:</span> <span class="kt">fs2.Stream</span><span class="o">[</span><span class="kt">cats.effect.IO</span>,<span class="kt">mpc4s.protocol.Response</span><span class="o">[</span><span class="kt">mpc4s.protocol.answer.SongListAnswer</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">(..)</span>
<span class="n">scala</span><span class="o">&gt;</span> <span class="nv">resp</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">toVector</span><span class="o">.</span><span class="py">unsafeRunSync</span>
<span class="n">res1</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">mpc4s.protocol.Response</span><span class="o">[</span><span class="kt">mpc4s.protocol.answer.SongListAnswer</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Vector</span><span class="o">(</span><span class="nc">MpdResult</span><span class="o">(</span><span class="nc">SongListAnswer</span><span class="o">(</span><span class="nc">SongList</span><span class="o">(</span><span class="nc">Vector</span><span class="o">(</span><span class="nc">Song</span><span class="o">(</span><span class="nc">Uri</span><span class="o">(</span><span class="nc">Eike</span><span class="o">/</span><span class="n">classic</span><span class="o">/</span><span class="nc">Ladislav</span> <span class="nc">Jelinek</span><span class="o">/</span><span class="nc">Ladislav</span> <span class="nc">Jelinek</span> <span class="n">plays</span> <span class="nc">Beethoven</span><span class="o">/</span><span class="mi">01</span><span class="o">-</span><span class="nc">Sonata</span> <span class="n">C</span> <span class="nc">Major</span> <span class="nc">Op53</span> <span class="nc">Waldstein</span> <span class="nc">Allegro</span> <span class="n">con</span> <span class="nf">brio</span> <span class="o">(</span><span class="n">L</span> <span class="n">van</span> <span class="nc">Beethoven</span><span class="o">)-</span><span class="nc">Ladislav</span> <span class="nv">Jelinek</span><span class="o">.</span><span class="py">flac</span><span class="o">),</span><span class="nc">Some</span><span class="o">(</span><span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">16</span><span class="n">T18</span><span class="k">:</span><span class="err">45</span><span class="kt">:</span><span class="err">13</span><span class="kt">Z</span><span class="o">),</span><span class="nc">Some</span><span class="o">(</span><span class="nc">Seconds</span><span class="o">(</span><span class="mi">683</span><span class="o">)),</span><span class="nc">Some</span><span class="o">(</span><span class="mf">683.0</span><span class="o">),</span><span class="nc">ListMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="nc">Title</span> <span class="o">-&gt;</span> <span class="nc">Sonata</span> <span class="n">C</span> <span class="nc">Major</span> <span class="nc">Op53</span> <span class="nc">Waldstein</span><span class="o">,</span> <span class="nc">Allegro</span> <span class="n">con</span> <span class="nf">brio</span> <span class="o">(</span><span class="n">L</span> <span class="n">van</span> <span class="nc">Beethoven</span><span class="o">),</span> <span class="nc">Composer</span> <span class="o">-&gt;</span> <span class="nc">Ludwig</span> <span class="n">van</span> <span class="nc">Beethoven</span><span class="o">,</span> <span class="nc">Album</span> <span class="o">-&gt;</span> <span class="nc">Ladislav</span> <span class="nc">Jelinek</span> <span class="n">plays</span> <span class="nc">Beethoven</span><span class="o">,</span> <span class="nc">Track</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">Albumartist</span> <span class="o">-&gt;</span> <span class="nc">Ladislav</span> <span class="nc">Jelinek</span><span class="o">,</span> <span class="nc">Artist</span> <span class="o">-&gt;</span> <span class="nc">Ladislav</span> <span class="nc">Jelinek</span><span class="o">,</span> <span class="nc">Date</span> <span class="o">-&gt;</span> <span class="mi">2011</span><span class="o">,</span> <span class="nc">Comment</span> <span class="o">-&gt;</span> <span class="n">http</span><span class="o">://</span><span class="nv">magnatune</span><span class="o">.</span><span class="py">com</span><span class="o">/</span><span class="n">artists</span><span class="o">/</span><span class="n">ladislav_jelinek</span><span class="o">,</span> <span class="nc">Genre</span> <span class="o">-&gt;</span> <span class="nc">Classical</span><span class="o">))),</span> <span class="nc">Song</span><span class="o">(</span><span class="nc">Uri</span><span class="o">(</span><span class="nc">Eike</span><span class="o">/</span><span class="n">classic</span><span class="o">/</span><span class="nc">Ladislav</span> <span class="nc">Jelinek</span><span class="o">/</span><span class="nc">Ladislav</span> <span class="nc">Jelinek</span> <span class="n">plays</span> <span class="nc">Beethoven</span><span class="o">/</span><span class="mi">02</span><span class="o">-</span><span class="nc">Sonata</span> <span class="n">C</span> <span class="nc">Major</span> <span class="n">O</span><span class="o">...</span>
</code></pre></div></div>

<p>In this example the codec for the response is chosen at compile
time. When the concrete command is not known at compile time, one can
use a runtime registry. Then a different <code class="highlighter-rouge">send</code> method is used:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="nv">resp</span> <span class="k">=</span> <span class="nv">mpc</span><span class="o">.</span><span class="py">send1</span><span class="o">(</span><span class="nc">Search</span><span class="o">(</span><span class="nv">Filter</span><span class="o">.</span><span class="py">tags</span><span class="o">(</span><span class="nv">Tag</span><span class="o">.</span><span class="py">Album</span> <span class="o">-&gt;</span> <span class="s">"plays"</span><span class="o">),</span> <span class="nc">None</span><span class="o">,</span> <span class="nc">None</span><span class="o">),</span> <span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span>
<span class="n">resp</span><span class="k">:</span> <span class="kt">fs2.Stream</span><span class="o">[</span><span class="kt">cats.effect.IO</span>,<span class="kt">mpc4s.protocol.Response</span><span class="o">[</span><span class="kt">mpc4s.protocol.Answer</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Stream</span><span class="o">(..)</span>
<span class="n">scala</span><span class="o">&gt;</span> <span class="nv">resp</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">toVector</span><span class="o">.</span><span class="py">unsafeRunSync</span>
<span class="n">res2</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">mpc4s.protocol.Response</span><span class="o">[</span><span class="kt">mpc4s.protocol.Answer</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Vector</span><span class="o">(</span><span class="nc">MpdResult</span><span class="o">(</span><span class="nc">SongListAnswer</span><span class="o">(</span><span class="nc">SongList</span><span class="o">(</span><span class="nc">Vector</span><span class="o">(</span><span class="nc">Song</span><span class="o">(</span><span class="nc">Uri</span><span class="o">(</span><span class="nc">Eike</span><span class="o">/</span><span class="n">classic</span><span class="o">/</span><span class="nc">Ladislav</span> <span class="nc">Jelinek</span><span class="o">/</span><span class="nc">Ladislav</span> <span class="nc">Jelinek</span> <span class="n">plays</span> <span class="nc">Beethoven</span><span class="o">/</span><span class="mi">01</span><span class="o">-</span><span class="nc">Sonata</span> <span class="n">C</span> <span class="nc">Major</span> <span class="nc">Op53</span> <span class="nc">Waldstein</span> <span class="nc">Allegro</span> <span class="n">con</span> <span class="nf">brio</span> <span class="o">(</span><span class="n">L</span> <span class="n">van</span> <span class="nc">Beethoven</span><span class="o">)-</span><span class="nc">Ladislav</span> <span class="nv">Jelinek</span><span class="o">.</span><span class="py">flac</span><span class="o">),</span><span class="nc">Some</span><span class="o">(</span><span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">16</span><span class="n">T18</span><span class="k">:</span><span class="err">45</span><span class="kt">:</span><span class="err">13</span><span class="kt">Z</span><span class="o">),</span><span class="nc">Some</span><span class="o">(</span><span class="nc">Seconds</span><span class="o">(</span><span class="mi">683</span><span class="o">)),</span><span class="nc">Some</span><span class="o">(</span><span class="mf">683.0</span><span class="o">),</span><span class="nc">ListMap</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span><span class="nc">Title</span> <span class="o">-&gt;</span> <span class="nc">Sonata</span> <span class="n">C</span> <span class="nc">Major</span> <span class="nc">Op53</span> <span class="nc">Waldstein</span><span class="o">,</span> <span class="nc">Allegro</span> <span class="n">con</span> <span class="nf">brio</span> <span class="o">(</span><span class="n">L</span> <span class="n">van</span> <span class="nc">Beethoven</span><span class="o">),</span> <span class="nc">Composer</span> <span class="o">-&gt;</span> <span class="nc">Ludwig</span> <span class="n">van</span> <span class="nc">Beethoven</span><span class="o">,</span> <span class="nc">Album</span> <span class="o">-&gt;</span> <span class="nc">Ladislav</span> <span class="nc">Jelinek</span> <span class="n">plays</span> <span class="nc">Beethoven</span><span class="o">,</span> <span class="nc">Track</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">,</span> <span class="nc">Albumartist</span> <span class="o">-&gt;</span> <span class="nc">Ladislav</span> <span class="nc">Jelinek</span><span class="o">,</span> <span class="nc">Artist</span> <span class="o">-&gt;</span> <span class="nc">Ladislav</span> <span class="nc">Jelinek</span><span class="o">,</span> <span class="nc">Date</span> <span class="o">-&gt;</span> <span class="mi">2011</span><span class="o">,</span> <span class="nc">Comment</span> <span class="o">-&gt;</span> <span class="n">http</span><span class="o">://</span><span class="nv">magnatune</span><span class="o">.</span><span class="py">com</span><span class="o">/</span><span class="n">artists</span><span class="o">/</span><span class="n">ladislav_jelinek</span><span class="o">,</span> <span class="nc">Genre</span> <span class="o">-&gt;</span> <span class="nc">Classical</span><span class="o">))),</span> <span class="nc">Song</span><span class="o">(</span><span class="nc">Uri</span><span class="o">(</span><span class="nc">Eike</span><span class="o">/</span><span class="n">classic</span><span class="o">/</span><span class="nc">Ladislav</span> <span class="nc">Jelinek</span><span class="o">/</span><span class="nc">Ladislav</span> <span class="nc">Jelinek</span> <span class="n">plays</span> <span class="nc">Beethoven</span><span class="o">/</span><span class="mi">02</span><span class="o">-</span><span class="nc">Sonata</span> <span class="n">C</span> <span class="nc">Major</span> <span class="nc">Op53</span> <span class="nc">Waldstein</span> <span class="n">I</span><span class="o">...</span>
</code></pre></div></div>

<p>In the first example, the result type was a concrete anwser type
(<code class="highlighter-rouge">Response[SongListAnswer]</code>), because it could be found at compile
time. In the second example the result type is <code class="highlighter-rouge">Response[Answer]</code>
which must be casted to a concrete type first to be useful.</p>

<p>These commands open each a new connection to MPD and so the mpd
commands <code class="highlighter-rouge">idle</code>/<code class="highlighter-rouge">noidle</code> are not allowed. If you want to listen for
events, use the <code class="highlighter-rouge">idle</code> method on <code class="highlighter-rouge">MpdClient</code>.</p>

<h2 id="mpds-idle-mode">MPD’s idle mode</h2>

<p>When a connection is opened to MPD it expects a command in a certain
time window. If that passes, the connection is closed by MPD due to a
timeout.</p>

<p>To be notified by MPD events and to reuse a single connection more
efficiently, the <code class="highlighter-rouge">idle</code> command can be used. Read more about this
<a href="https://www.musicpd.org/doc/protocol/command_reference.html#status_commands">here</a>.</p>

<p>The <code class="highlighter-rouge">idle</code> method on <code class="highlighter-rouge">MpdClient</code> opens a new connection to MPD and
immediatly sends the <code class="highlighter-rouge">idle</code> command, effectively disabling the server
timeout.</p>

<p>Here is an example. Note that it requires a running MPD to be useful:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Effect</span><span class="o">,</span> <span class="nc">IO</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2._</span>
<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">java.util.concurrent.atomic.AtomicLong</span>
<span class="k">import</span> <span class="nn">java.nio.channels.AsynchronousChannelGroup</span>
<span class="k">import</span> <span class="nn">java.util.concurrent._</span>

<span class="k">import</span> <span class="nn">mpc4s.protocol._</span>
<span class="k">import</span> <span class="nn">mpc4s.protocol.commands._</span>
<span class="k">import</span> <span class="nn">mpc4s.client._</span>

<span class="k">implicit</span> <span class="k">val</span> <span class="nv">EC</span> <span class="k">=</span> <span class="nv">ExecutionContext</span><span class="o">.</span><span class="py">fromExecutorService</span><span class="o">(</span><span class="nv">Executors</span><span class="o">.</span><span class="py">newCachedThreadPool</span><span class="o">)</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="nv">ACG</span> <span class="k">=</span> <span class="nv">AsynchronousChannelGroup</span><span class="o">.</span><span class="py">withThreadPool</span><span class="o">(</span><span class="nc">EC</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">mpc</span> <span class="k">=</span> <span class="nc">MpdClient</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="nc">Connect</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">6600</span><span class="o">))</span>

<span class="k">def</span> <span class="nf">everySecond</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Effect</span><span class="o">]</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nc">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">delay</span><span class="o">(</span><span class="k">new</span> <span class="nc">AtomicLong</span><span class="o">(</span><span class="mi">0</span><span class="o">))).</span>
    <span class="nf">flatMap</span><span class="o">(</span><span class="n">counter</span> <span class="k">=&gt;</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">every</span><span class="o">(</span><span class="mf">1.</span><span class="n">seconds</span><span class="o">).</span>
      <span class="nf">filter</span><span class="o">(</span><span class="k">_</span> <span class="o">==</span> <span class="kc">true</span><span class="o">).</span>
      <span class="nf">evalMap</span><span class="o">(</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">Effect</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">delay</span><span class="o">(</span><span class="nv">counter</span><span class="o">.</span><span class="py">getAndIncrement</span><span class="o">)))</span>
<span class="o">}</span>

<span class="k">def</span> <span class="nf">print</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Response</span><span class="o">[</span><span class="kt">Answer</span><span class="o">]]</span> <span class="k">=</span>
  <span class="nv">_</span><span class="o">.</span><span class="py">evalMap</span><span class="o">(</span><span class="n">ans</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"&gt;&gt;&gt;&gt; $ans"</span><span class="o">)))</span>

<span class="k">val</span> <span class="nv">connect</span> <span class="k">=</span> <span class="nc">Connect</span><span class="o">(</span><span class="s">"127.0.0.1"</span><span class="o">,</span> <span class="mi">6700</span><span class="o">)</span>

<span class="k">val</span> <span class="nv">read</span> <span class="k">=</span> <span class="nc">MpdClient</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">connect</span><span class="o">).</span><span class="py">idle</span><span class="o">.</span>
  <span class="n">flatMap</span> <span class="o">{</span> <span class="n">m</span> <span class="k">=&gt;</span>
    <span class="k">val</span> <span class="nv">actions</span> <span class="k">=</span> <span class="n">everySecond</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span>
      <span class="nf">take</span><span class="o">(</span><span class="mi">6</span><span class="o">).</span>
      <span class="nf">evalMap</span><span class="o">({</span>
        <span class="k">case</span> <span class="mi">0</span> <span class="k">=&gt;</span> <span class="nv">m</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nc">CommandOrList</span><span class="o">(</span><span class="nc">Status</span><span class="o">))</span>
        <span class="k">case</span> <span class="mi">1</span> <span class="k">=&gt;</span> <span class="nv">m</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nc">CommandOrList</span><span class="o">(</span><span class="nc">Clear</span><span class="o">))</span>
        <span class="k">case</span> <span class="mi">2</span> <span class="k">=&gt;</span> <span class="nv">m</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nc">CommandOrList</span><span class="o">(</span><span class="nc">SearchAdd</span><span class="o">(</span><span class="nv">Filter</span><span class="o">.</span><span class="py">tags</span><span class="o">(</span><span class="nv">Tag</span><span class="o">.</span><span class="py">Composer</span> <span class="o">-&gt;</span> <span class="s">"Beethoven"</span><span class="o">))))</span>
        <span class="k">case</span> <span class="mi">3</span> <span class="k">=&gt;</span> <span class="nv">m</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nc">CommandOrList</span><span class="o">(</span><span class="nc">Play</span><span class="o">(</span><span class="nc">None</span><span class="o">)))</span>
        <span class="k">case</span> <span class="mi">4</span> <span class="k">=&gt;</span> <span class="nv">m</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nc">CommandOrList</span><span class="o">(</span><span class="nc">Status</span><span class="o">))</span>
        <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">IO</span><span class="o">(())</span>
      <span class="o">})</span>

    <span class="nv">actions</span><span class="o">.</span><span class="py">concurrently</span><span class="o">(</span><span class="nv">m</span><span class="o">.</span><span class="py">read</span><span class="o">.</span><span class="py">to</span><span class="o">(</span><span class="n">print</span><span class="o">))</span>
  <span class="o">}</span>

<span class="nv">read</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span> <span class="c1">//.unsafeRunSync // only works if mpd is running</span>
</code></pre></div></div>

<p>In this example every second a command is send to mpd using a single
connection. The same connection is used to read the responses. Both
things happen concurrently. At first, the current status is
fetched. Then the playlist is cleared and filled with all songs from
the database that have a <em>Composer</em> tag including the value
“Beethoven”. Then playback is started. And at last, the current status
is fetched again.</p>

<p>This prints something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt;&gt;&gt; MpdResult(StatusAnswer(90,false,false,Off,false,1,0,Stop,None,None,None,None,None,None,None,None,None,Some(0.0),None,Some(),Some()))
&gt;&gt;&gt;&gt; MpdResult(Empty)
&gt;&gt;&gt;&gt; MpdResult(IdleAnswer(Vector(ChangeEvent(Playlist))))
&gt;&gt;&gt;&gt; MpdResult(Empty)
&gt;&gt;&gt;&gt; MpdResult(IdleAnswer(Vector(ChangeEvent(Playlist))))
&gt;&gt;&gt;&gt; MpdResult(Empty)
&gt;&gt;&gt;&gt; MpdResult(IdleAnswer(Vector(ChangeEvent(Player))))
&gt;&gt;&gt;&gt; MpdResult(StatusAnswer(90,false,false,Off,false,3,254,Play,Some(0),Some(Id(1)),Some(1),Some(Id(2)),Some(Range(1,407)),Some(1.137),Some(406.8),Some(198),None,Some(0.0),Some(AudioFormat(44100,16,2)),Some(),Some()))
&gt;&gt;&gt;&gt; MpdResult(IdleAnswer(Vector(ChangeEvent(Player))))
</code></pre></div></div>

<p>The code above sent 5 commands, but 9 responses have been
recorded. The reason is that MPD sent events about state changes
through this connection – the purpose of the <code class="highlighter-rouge">idle</code> command. The state
changes were caused by the commands themselves.</p>

<p>You can see a more realistic use case in the <a href="./http.html">http
module</a> where this is used to back the websockets
connection.</p>

<h2 id="dependencies">Dependencies</h2>

<p>This module has the following dependencies:</p>

<ul>
  <li><a href="protocol.html">mpc4s-protocol</a></li>
  <li><a href="https://github.com/functional-streams-for-scala/fs2">fs2-core and fs2-io</a></li>
</ul>
</section></div></div></div></div><script src="/mpc4s/highlight/highlight.pack.js"></script><script>
// For all code blocks, copy the language from the containing div
// to the inner code tag (where hljs expects it to be)
const langPrefix = 'language-';
document.querySelectorAll(`div[class^='${langPrefix}']`).forEach(function(div) {
  div.classList.forEach(function(cssClass) {
    if (cssClass.startsWith(langPrefix)) {
      const lang = cssClass.substring(langPrefix.length);
      div.querySelectorAll('pre code').forEach(function(code) {
        code.classList.add(lang);
      });
    }
  });
});

hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
      </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script src="/mpc4s/js/docs.js"></script></body></html>